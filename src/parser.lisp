(in-package :cl-user)
(defpackage stepster.parser 
  (:use :cl)
  (:import-from	:stepster.urlworks
                :same-domain
                :join-with-main
                :prepare-url
                :make-query-string
                :get-last)
  (:import-from :stepster.json-works
                :getj)
  (:import-from :stepster.utils
                :print-error
                :substp
                :equal-getf
                :pathname-as-directory
                :clist)
  (:export
   :parse
   :attribute
   :collect-from
   :nodes-to-string
   :node-with-attr
   :find-by-text
   :page-text
   :download-file
   :download-page
   :extract-forms
   :parse-json
   :get-json
   :post-json
   :safe-get
   :safe-post
   :parse-regex
   :check-attr
   :prepare-url
   :get-status-code
   :parse-by-class
   :submit-form
   :fill-form))

(in-package :stepster.parser)


(defparameter *cookie-jar* (cl-cookie:make-cookie-jar))
(defparameter *user-agent-header* '(("User-Agent" . "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0")))

(defun nodes-to-string (list)
  "Return selector string from list of symbols."
  (if (consp list)
      (string-downcase (format nil "狺撖扉篝┅篝蜷铉扉篝┅ㄤ彐躅狒趄殁豸铒溴狒趄⒁弭躜狒趄殁豸骝镯铒溴痨蹴鸷狒趄殁豸铒溴篝蜷铉狒趄┅ㄤ彐躅疳蝮疳珏脲桢徜弪螬⒁弭躜痨蹴蝻雉铒溴骘玳鲥躜膦ㄨ犷潇弪汜箦ㄩ篝蜷铉疳珏痨蹴鸷疳蝮筢驽珏疳珏鸿遽溴蝮矧桢徜弪躞弪徵孱舡桢徜弪┅疳珏ㄥ蝌矧ㄥ铋飑┅ㄤ彐躅筢驽珏躜脲ㄨ遽溴蝮躞弪徵孱舡桢徜弪┅ㄨ犷潇弪汜箦ㄤ屮虹弭痱屦狎瀛躜躜飑恒镲腴瀛赆泔镫殄赆颡鸿遽溴蝮桢徜弪螬ㄥ蝌矧ㄥ痱轭舡弪蝻濠┅ㄤ彐躅筢驽痫篝躜溽翎脲ㄨ遽溴蝮躞弪徵孱舡桢徜弪┅ㄨ犷潇弪汜箦ㄤ屮吼矬痱屦狎瀛躜躜飑恒镲腴瀛赆泔镫殄赆颡鸿遽溴蝮桢徜弪恒镱翦铘溽翎ㄥ蝌矧ㄥ痱轭舡弪蝻濠┅ㄤ彐躅珏舡牦镱躜飑觑钺翳犷吼狎箦筢驽珏躜飑┅ㄤ彐躅痫篝牦镱躜溽翎筢驽痫篝躜溽翎鸿遽溴蝮Жá蔑铘孱舡赠疱⑨痧扉汜糸镱牦镱┅┅ㄤ彐躅珏舡篝狒躞泔溴躜飑ㄨ犷潇弪汜箦铘璀鲠祯ㄤ屮虹弭痱屦狎瀛躜躜飑鸿遽溴蝮躞弪徵孱舡桢徜弪┅ㄤ屮鸿趑瓠蝈聃弩舡忉洵蝈聃弩ī窗癌ㄤ屮鸿趑瓠蝈聃弩舡驷殪邃ㄥㄤ屮候弩痫铙瀛篝狒躞濠ㄥ蝌矧ㄥ濠┅ㄤ彐躅疳珏翦疳珏⒁弭躜篝蜷铉镦翦骝镯犰镦翳汨殪潋孱铒溴螽戾è铒溴疳蝮疳珏┅翦舡扉篝铋飑痨蹴鸷趄狯弪箦铒溴灬礅溽铒溴瘐箬痨蹴鸷翦铒溴翦舡扉篝┅呼弩＇痨蹴鸷翦舡铒溴皓ㄡ痧禊＇泔钽狒孱狒篝蜷铉铗弼弪箦翦舡扉篝┅┅ㄤ彐躅骈钿怡翦疳蝈铘铒溴翦脲狒趄戾è蝈篚祠铋飑痨蹴鸷趄狯弪箦疳蝈铘铒溴灬礅溽铒溴箦翩蝈篚祠ㄩ狒趄ㄡ趑蜷怩翦痨蹴鸷疳蝈铘铒溴狒趄痨蹴鸷疳蝈铘铒溴┅┅呼弩灬礅溽铒溴ㄡ钿痨蹴鸷翦舡铒溴铒溴篚怏麴翦痨蹴鸷翦铒溴┅┅蝈篚祠┅ㄤ彐躅滹黝祜徜骈戾躜骈戾钺礤戾è蝈箴镱箦筢驽珏躜飑┅鏖翳镳孱骈戾篝蝈犴骈戾钺礤轰轵邈糸镱猴豸瘐哄戾礤铘豉疱Ж躅箝珙邃怡翦俯洪姝屮轶趔后躔弪箦溴麒孱蝈箴镱箦祜镳骘怡翦徙蝻篌蝈箴镱箦滹黩轸瀛怡翦怡翦篝蝈犴┅┅┅ㄤ彐躅滹黝祜徜疳珏躜骈戾钺礤戾è蝈箴镱箦筢驽珏躜飑┅鏖翳镳孱骈戾篝蝈犴骈戾钺礤轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴麒孱蝈箴镱箦黩轸瀛篝蜷铉蝈箴镱箦篝蝈犴┅┅ㄤ彐躅泔祆邈舡骝镯疳蝈铘铒溴箦戾泗矧脲狒趄翦篝翦篝狎珞⒁弭躜扉篝镦铒溴矧狒趄殁豸弩骝镯疳蝌孱铒溴祜镳骘铒溴徙蝻篌ㄣ祗蠛箦戾泗铒溴蟓麸篝蜷铉箦戾泗矧螬疳蝈铘铒溴鏖翳狒趄殁豸躅戾篌狒趄麒孱矧铒翦篝ㄡ痧禊翦篝ㄣ扉篝铒溴翦篝狎珞┅泔祆邈铒溴屐箦滹铛祆铋飑屐箦滹箦翩狒趄殁豸ㄡ趑蜷怩翦铒溴狒趄┅犷麒孱矧铒翦篝ㄡ痧禊翦篝ㄣ扉篝铒溴翦篝狎珞┅泔祆邈狒趄殁豸濠ㄤ彐躅铒溴鏖翳狒趄疳蝈铘铒溴箦戾泗矧狒趄鲠飑ㄨ犷潇弪汜箦祜镳骘铒溴徙蝻篌ㄣ祗蠛箦戾泗铒溴蟓麸篝蜷铉箦戾泗矧疳蝈铘铒溴麒孱ㄥ聃犰ㄡ趑蜷怩翦铒溴狒趄鲠飑蝈趱蝾铒溴ㄥ蝌矧ㄥ痱镧痱轭濠铋飑┅ㄤ彐躅汨邈氕狒趄ㄡ趑蜷怩翦骢瞟＇灬礅溽铒溴狒趄ㄦ躅汜祆骢狒趄ㄡ趑蜷怩翦铒溴狒趄殁豸濠┅ㄤ彐躅篚忭轸骘蝽躜脲骘蝽溽翎戾舄è骘蝽ㄥ趄徙舡骘蝽疳蝮躜飑麒孱骘蝽骘蝽┅ㄡ泗轱觑轭鏖翳磲轭躜ㄡ趑蜷怩翦骘蝽п泗轱瞟┅礤翳镤ㄡ趑蜷怩翦骘蝽ы弭栾洎ㄤ狒ㄦ殪飙骘蝽骘蝽溽翎┅ㄩ篝蜷铉羼踽礤翳镤痫篝筢驽痫篝徙糸镱溽翎筢驽珏磲脲聃弪篝蜷铉徙糸镱溽翎┅┅ㄤ彐躅骈祆骘蝽ㄦ矧溽翎⒁弭躜扉篝镦疳轵ㄩ铕豸钺礤鲠祯濠戾è轭瘐趔ㄣ镬戾泗骝镯骘蝽ч铕豸┅祜镳鏖翳轭瘐舡钺礤骘轭瘐轭轭瘐趔泔祆邈ㄣ镱箦翩轭瘐舡钺礤ㄡ趑蜷怩翦轭瘐ь犴濠矧ㄥ聃犰珏翩溽翎轭瘐舡钺礤ㄡ趑蜷怩翦轭瘐鲠祯濠┅┅ㄤ彐躅屮趄徙舡骘蝽疳珏镳糸镱犰钺礤⒁弭躜扉篝镦骘蝽骝镯疳珏矧箝铉戾骘蝽殒疳珏栳镱禊镱骘蝽矧箴邈殒殄骘蝽钺礤戾è骘蝽ㄣ镬戾泗骝镯疳珏ф矧愆┅ㄣ镱è铒ㄣ潋骘蝽螬ㄣ狎骘蝽螬钺礤祜镳骘骘蝽轭骘蝽麒孱篚怏麴钺礤ㄡ趑蜷怩翦骘蝽ь犴濠蝈趱蝾骘蝽┅骘蝽螬┅